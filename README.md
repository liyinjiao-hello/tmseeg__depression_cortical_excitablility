# tmseeg__depression_cortical_excitablility
code and source data for the study: Circadian characteristics of cortical excitability in patients with major depressive disorder: a TMS-EEG study

## System Requirements

The software was developed and tested with the following dependencies and operating systems:

### Operating System
- Windows 11 (x64)

### MATLAB
- MATLAB R2023a  
- Required toolboxes:
  - Signal Processing
  - Statistics & Machine Learning
- EEGLAB plugins and toolboxes:
  - FastICA v2.5
  - FieldTrip (release 20240916)
  - RELAX v2.0.0
  - TESA v1.1.1

### Python
- Python 3.10  
- Required packages:
  - pandas 2.2.2
  - numpy 1.26.4

### R
- R v4.4.2  
- Required packages:
  - lme4 1.1.36
  - emmeans 1.11.1
 
  - 
## Installation Guide (Simplified)

### Download the repository
### MATLAB
- Install MATLAB R2023a  
- Install EEGLAB and add plugins:
  - FastICA v2.5
  - FieldTrip (20240916)
  - RELAX v2.0.0
  - TESA v1.1.1

### Python
- Install Python 3.10  
- Install required packages:

### R
- Install R v4.4.2  
- Install packages:

## Demo

### Instructions to run on data
The demo uses one preprocessed EEG dataset:  
'source_data/FigS1/HC01_F405_check.set'

To run the demo.m in MATLAB:
'code\Matlab_R2023a\demo.m'


### Expected output
- A butterfly plot of all EEG channels
- The ROI mean trace (channels AF4, F4, F2, F6, FC2, FC6, FC4) highlighted in red on top of the butterfly plot
- Optionally, a topomap panel at selected latencies (N45, P60, N100, P180), if included in the demo script

*These figures are displayed on screen only (no files are saved in the demo).*

---

## Reproduction Instructions

To reproduce the figures, tables, and analyses reported in the manuscript, use the source data and scripts provided in this repository.

### Figures

**Figure 2**  
- Source data: `tmseegpreprocesseddata` (all subjects’ preprocessed TMS-EEG files)  
- MATLAB script: `tep_extraction02.m` (extracts TEP amplitude and latency)  
- Processed outputs: TEP amplitude/latency sheets (derived from above script)

**Figure 3**  
- Source data: `psg_preprocessed_data` (all subjects’ preprocessed PSG files)  
- MATLAB script: `psg_swa_extraction04.m` (slow wave activity extraction)  
- Sheets:
  - `2025.2.26-saliva-melatonin-test` / `2025.2.26-saliva-cortisol-test`: raw assay data from company report
  - `all_cort` / `all_MT`: cleaned hormone values (outliers removed <80%), used in Python script `melatonin_auci.py`
  - `psg_r extracted`: slow wave dissipation rates (from `psg_swa_extraction04.m`)
  - `TEP allPeak recheck`: TEP values (from `tep_extraction02.m`)
  - `TEP fitting subject`: circadian parameters (acrophase, amplitude, mesor) obtained via Python script `cosinor_fitting.py`

**Figure 4**  
- Source data: `resteeg_preprocessed_data` (auto-processed resting EEG)  
- MATLAB script: `resteeg_theta_extraction02.m`  
- Sheets: `cpt`, `kss`, `pvt`, `vas`, `resteeg source data` (used for correlation with N100 TEP)

**Figure S1**  
- Representative TMS-EEG preprocessed file

**Figure S2**  
- See Figure 2

**Figure S3**  
- See Figure 3

**Figure S4**  
- Sheet: `table1_values` (RMT values per subject)  
- `TEP allPeak recheck`: see Figure 2

**Figure S5**  
- See Figure 4

---

### Tables

**Table 1**  
- Source: `table1_values` sheet

**Table 2**  
- Source: Output of LME analysis in R (including post-hoc)

**Table 3**  
- Same source data as Figure 3

**Table S1**  
- Source data:
  - `actigraphy_raw_data` (per-subject raw actigraphy files, processed with PyActigraphy in Python)
  - `psg_staging_report` (PSG reports generated by clinical physicians based on AASM guidelines)
  - Sleep diary sheet (original export from Wenjuanxing, www.wjx.cn)

**Table S2**  
- Source: LME analysis of TEP latencies

**Table S3**  
- See Figure 3

**Table S4**  
- See Figure 3

**Table S5**  
- Correlation outputs for P180
